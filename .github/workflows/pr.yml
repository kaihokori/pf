name: Pull Request

on:
  pull_request:
    types: [opened, edited, labeled, unlabeled, synchronize]

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  labels:
    name: Check Labels
    runs-on: ubuntu-latest
    steps:
      - name: Check for required labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          release_labels=("major" "minor" "patch")
          type_labels=("feature" "bugfix" "chore" "admin")

          response=$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.event.pull_request.issue_url }}/labels")

          if ! echo "$response" | jq -e . > /dev/null 2>&1; then
            echo "Error: Invalid JSON response from GitHub API"
            echo "Response: $response"
            exit 1
          fi

          labels=$(echo "$response" | jq -r '.[].name' 2> /dev/null)
          echo "Current labels: $labels"

          type_label_found=0
          admin_label_found=0
          for label in "${type_labels[@]}"; do
            if echo "$labels" | grep -qx "$label"; then
              type_label_found=1
              if [ "$label" = "admin" ]; then
                admin_label_found=1
              fi
            fi
          done

          if [ "$type_label_found" -eq 0 ]; then
            echo "Error: One of the type labels (${type_labels[*]}) must be added before merging."
            exit 1
          fi

          if [ "$admin_label_found" -eq 0 ]; then
            release_label_count=0
            for label in "${release_labels[@]}"; do
              if echo "$labels" | grep -qx "$label"; then
                release_label_count=$((release_label_count + 1))
              fi
            done
            if [ "$release_label_count" -eq 0 ]; then
              echo "Error: One of the release labels (${release_labels[*]}) must be added before merging."
              exit 1
            elif [ "$release_label_count" -gt 1 ]; then
              echo "Error: Only one release label should be assigned to a pull request. Found $release_label_count release labels."
              exit 1
            fi
          fi

          echo "Valid label(s) found. Proceeding."